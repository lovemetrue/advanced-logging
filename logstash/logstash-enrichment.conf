filter {
  # Генерация уникального ID для каждого запроса
  uuid {
    target => "request_id"
  }

  # Добавление геоданных по IP
  geoip {
    source => "client_ip"
    target => "geoip"
    database => "/usr/share/logstash/GeoLite2-City.mmdb"
  }

  # Обогащение пользовательскими данными (пример с внешним API)
  http {
    url => "http://user-service:8080/users/%{[user_id]}"
    target => "user_info"
    verb => "GET"
    headers => {
      "Authorization" => "Bearer ${USER_SERVICE_TOKEN}"
    }
    fallback => {
      "user_name" => "unknown"
      "user_role" => "guest"
    }
  }

  # Добавление бизнес-контекста
  translate {
    field => "http_status"
    destination => "status_category"
    dictionary => {
      "200" => "success"
      "201" => "success" 
      "400" => "client_error"
      "401" => "auth_error"
      "403" => "auth_error"
      "404" => "client_error"
      "500" => "server_error"
      "502" => "server_error"
      "503" => "server_error"
    }
    fallback => "unknown"
  }

  # Корреляция по request_id
  if [request_id] {
    # Поиск связанных логов за последние 5 минут
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      query => "request_id:%{[request_id]}"
      fields => {
        "[@timestamp]" => "related_timestamp"
        "service" => "related_service" 
        "level" => "related_level"
      }
      target => "correlated_logs"
    }
  }

  # Агрегация метрик
  metrics {
    meter => ["events"]
    add_tag => "metric"
    flush_interval => 30
    clear_interval => 300
  }
}
